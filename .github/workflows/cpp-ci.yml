name: cpp

on:
  push:
   paths:
    - 'cpp/**'
    - '.github/workflows/cpp-ci.yml'
  pull_request:
   paths:
    - 'cpp/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        uses: aminya/setup-cpp@v1
        with: 
          conan: 1.61.0
          cmake: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "cpp/src/format/bridge/rust -> target"

      - name: setup conan
        run: 
          conan remote add default-conan-local https://milvus01.jfrog.io/artifactory/api/conan/default-conan-local --insert
          && conan remote list
      
      - name: conan package cache
        uses: actions/cache@v4
        with:
          path: ~/.conan
          key: conan-cpp-${{ hashFiles('./cpp/conanfile.py') }}
          restore-keys: conan-cpp-

      - name: Build
        working-directory: ./cpp
        run: |
          make build USE_ASAN=True BUILD_TYPE=Release WITH_VORTEX=True

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: gtest-binary
          path: |
            cpp/build/Release/test/milvus_test
            cpp/build/Release/test/Test_FFI
            cpp/build/Release/libs/
            cpp/build/Release/libmilvus-storage.so*

  lint:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        uses: aminya/setup-cpp@v1
        with:
          conan: 1.61.0
          cmake: true

      - name: setup conan
        run:
          conan remote add default-conan-local https://milvus01.jfrog.io/artifactory/api/conan/default-conan-local --insert
          && conan remote list

      - name: conan package cache
        uses: actions/cache@v4
        with:
          path: ~/.conan
          key: conan-cpp-${{ hashFiles('./cpp/conanfile.py') }}
          restore-keys: conan-cpp-

      - name: Build
        working-directory: ./cpp
        run: |
          make build BUILD_TYPE=Release

      - name: check-tidy
        working-directory: ./cpp
        run: |
          make check-tidy

  unittest:
    runs-on: ubuntu-22.04
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: gtest-binary
          path: ./cpp/build/Release

      - name: Change mod of binary
        working-directory: ./cpp
        run: |
          chmod +x ./build/Release/test/milvus_test
          chmod +x ./build/Release/test/Test_FFI

      - name: Setup Minio
        run: |
          chmod +x ./cpp/scripts/setup_minio.sh
          ./cpp/scripts/setup_minio.sh

      - name: Run unittest with local filesystem
        working-directory: ./cpp
        run: |
          export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$(pwd)/build/Release:$(pwd)/build/Release/libs
          ./build/Release/test/milvus_test && ./build/Release/test/Test_FFI
          
      - name: Run unittest with minio
        working-directory: ./cpp
        run: |
          export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$(pwd)/build/Release:$(pwd)/build/Release/libs
          source ./scripts/minio_env.sh && ./build/Release/test/milvus_test
          
